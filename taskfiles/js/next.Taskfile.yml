# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

env:
  NEXT_TELEMETRY_DISABLED: "1"

tasks:
  dev:
    internal: true
    desc: Run the Next.js app in development mode
    deps: [":js:install-deps"]
    dotenv: [env/run.local.env, env/run.env]
    cmd: "{{.JS_EXEC}} next dev --turbopack"

  build:
    internal: true
    desc: Build the Next.js app for production
    deps: [":js:install-deps"]
    sources:
      - next.config.*
      - tsconfig.json
      - public/**
      - src/**
      - exclude: src/**/*.{stories,test}.*
    generates:
      - out/next/dist/**
    cmd: "{{.JS_EXEC}} next build --turbopack"

  build:standalone:
    internal: true
    desc: Build the Next.js app for production in standalone mode
    deps: [build]
    preconditions:
      - sh: test -d out/next/dist/standalone
        msg: Standalone output not detected, please enable it in Next.js config
    sources:
      - out/next/dist/standalone/**
    generates:
      - out/next/standalone/**
    cmds:
      - rm -rf out/next/standalone
      - cp -r out/next/dist/standalone out/next/standalone
      - mkdir -p out/next/standalone/out/next/dist
      - cp -r out/next/dist/cache out/next/standalone/out/next/dist/cache
      - cp -r out/next/dist/static out/next/standalone/out/next/dist/static
      - cp -r public out/next/standalone/
      - 'echo ''{"type":"commonjs"}'' > out/next/standalone/package.json'

  start:
    internal: true
    desc: Start the Next.js production server
    deps: [build]
    dotenv: [env/run.local.env, env/run.env]
    cmd: "{{.JS_EXEC}} next start"

  start:standalone:
    internal: true
    desc: Start the Next.js production server in standalone mode
    deps: [build:standalone]
    dotenv: [env/run.local.env, env/run.env]
    cmd: node out/next/standalone/server.js
