# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

tasks:
  dev:
    internal: true
    desc: Run the Next.js app in development mode
    deps: [":js:install-deps"]
    cmd: "{{.JS_EXEC}} next dev --turbopack"

  build:
    internal: true
    desc: Build the Next.js app for production
    deps: [":js:install-deps"]
    sources:
      - next.config.*
      - tsconfig.json
      - public/**
      - src/**
    generates:
      - out/next/dist/**
    cmd: "{{.JS_EXEC}} next build --turbopack"

  build:standalone:
    internal: true
    desc: Build the Next.js app for production in standalone mode
    deps: [build]
    preconditions:
      - sh: test -d out/next/dist/standalone
        msg: Standalone output not detected, please enable it in Next.js config
    sources:
      - out/next/dist/standalone/**
    generates:
      - out/next/standalone/**
    cmds:
      - rm -rf out/next/standalone
      - cp -a out/next/dist/standalone out/next/standalone
      - mkdir -p out/next/standalone/out/next/dist
      - cp -a out/next/dist/cache out/next/standalone/out/next/dist/cache
      - cp -a out/next/dist/static out/next/standalone/out/next/dist/static
      - cp -a public out/next/standalone/
      - jq --null-input --arg type commonjs '$ARGS.named' > out/next/standalone/package.json

  start:
    internal: true
    desc: Start the Next.js production server
    deps: [build]
    cmd: "{{.JS_EXEC}} next start"

  start:standalone:
    internal: true
    desc: Start the Next.js production server in standalone mode
    deps: [build:standalone]
    cmd: "node out/next/standalone/server.js"
